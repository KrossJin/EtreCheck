#!/usr/bin/env perl

use strict;

my ($bundleID) = shift() =~ /--id=(.+)/;
my $root = shift() eq '--root';

die "Usage: generate_malware --id=<bundle identifier> [--root]\n"
  if not $bundleID;
  
my $executable = <<"EOS";
#!/usr/bin/env perl

use strict;

while(1)
  {
  system("/bin/date >> /tmp/$bundleID.out");
  sleep 10;
  }
EOS

my $executablePath = "/Library/Application Support/$bundleID/app";

$executablePath = $ENV{HOME} . $executablePath
  if not $root;
  
my $plist = <<"EOS";
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple Computer//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
	<key>KeepAlive</key>
	<true/>
	<key>Label</key>
	<string>$bundleID</string>
	<key>RunAtLoad</key>
	<true/>
	<key>Program</key>
	<string>$executablePath</string>
</dict>
</plist>
EOS

my $plistPath = "/Library/LaunchAgents/$bundleID.plist";

$plistPath = $ENV{HOME} . $plistPath
  if not $root;

my $sudo = $root ? 'sudo ' : '';
my $prefix = $root ? '' : $ENV{HOME};

unlink "/tmp/$bundleID/app";
rmdir "/tmp/$bundleID";
mkdir "/tmp/$bundleID";

open(OUT, '>', "/tmp/$bundleID/app") 
  or die "Couldn't build temporary executable";
  
print OUT $executable;

close(OUT);

system("/bin/chmod ugo+x /tmp/$bundleID/app");

open(OUT, '>', "/tmp/$bundleID.plist") 
  or die "Couldn't build temporary launchd config file";
  
print OUT $plist;

close(OUT);

system(qq{$sudo/bin/mv /tmp/$bundleID "$prefix/Library/Application Support/$bundleID"});
system("$sudo/bin/mv /tmp/$bundleID.plist $prefix/Library/LaunchAgents/$bundleID.plist");

system(qq{$sudo/usr/sbin/chown -R root:wheel "$prefix/Library/Application Support/$bundleID"});
system("$sudo/usr/sbin/chown root:wheel $prefix/Library/LaunchAgents/$bundleID.plist");

system("$sudo/bin/launchctl load -w $prefix/Library/LaunchAgents/$bundleID.plist");

print "Malware $bundleID installed and running";
print " as root"
  if $root;
print "\n";